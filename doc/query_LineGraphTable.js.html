<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>query/LineGraphTable.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="About.html">About</a></li><li><a href="Agency.html">Agency</a></li><li><a href="DateTime.html">DateTime</a><ul class='methods'><li data-type='method'><a href="DateTime.html#.create">create</a></li><li data-type='method'><a href="DateTime.html#.createFromDate">createFromDate</a></li><li data-type='method'><a href="DateTime.html#.createFromJSDate">createFromJSDate</a></li><li data-type='method'><a href="DateTime.html#.createFromTime">createFromTime</a></li><li data-type='method'><a href="DateTime.html#.now">now</a></li><li data-type='method'><a href="DateTime.html#clone">clone</a></li><li data-type='method'><a href="DateTime.html#deltaDays">deltaDays</a></li><li data-type='method'><a href="DateTime.html#deltaMins">deltaMins</a></li><li data-type='method'><a href="DateTime.html#getDateDOW">getDateDOW</a></li><li data-type='method'><a href="DateTime.html#getDateInt">getDateInt</a></li><li data-type='method'><a href="DateTime.html#getDateReadable">getDateReadable</a></li><li data-type='method'><a href="DateTime.html#getTimeGTFS">getTimeGTFS</a></li><li data-type='method'><a href="DateTime.html#getTimeInt">getTimeInt</a></li><li data-type='method'><a href="DateTime.html#getTimeReadable">getTimeReadable</a></li><li data-type='method'><a href="DateTime.html#getTimeSeconds">getTimeSeconds</a></li><li data-type='method'><a href="DateTime.html#isDateSet">isDateSet</a></li><li data-type='method'><a href="DateTime.html#toHTTPString">toHTTPString</a></li><li data-type='method'><a href="DateTime.html#toMySQLString">toMySQLString</a></li><li data-type='method'><a href="DateTime.html#toString">toString</a></li><li data-type='method'><a href="DateTime.html#toTimestamp">toTimestamp</a></li></ul></li><li><a href="Favorite.html">Favorite</a><ul class='methods'><li data-type='method'><a href="Favorite.html#.createStation">createStation</a></li><li data-type='method'><a href="Favorite.html#.createTrip">createTrip</a></li><li data-type='method'><a href="Favorite.html#.sortBySequence">sortBySequence</a></li><li data-type='method'><a href="Favorite.html#isStation">isStation</a></li><li data-type='method'><a href="Favorite.html#isTrip">isTrip</a></li></ul></li><li><a href="Holiday.html">Holiday</a></li><li><a href="Link.html">Link</a></li><li><a href="Route.html">Route</a><ul class='methods'><li data-type='method'><a href="Route.html#.sortByName">sortByName</a></li></ul></li><li><a href="Service.html">Service</a></li><li><a href="ServiceException.html">ServiceException</a></li><li><a href="Stop.html">Stop</a><ul class='methods'><li data-type='method'><a href="Stop.html#.sortByDistance">sortByDistance</a></li><li data-type='method'><a href="Stop.html#.sortById">sortById</a></li><li data-type='method'><a href="Stop.html#.sortByName">sortByName</a></li><li data-type='method'><a href="Stop.html#.sortByTransferWeight">sortByTransferWeight</a></li><li data-type='method'><a href="Stop.html#setDistance">setDistance</a></li></ul></li><li><a href="StopTime.html">StopTime</a><ul class='methods'><li data-type='method'><a href="StopTime.html#.sortByStopSequence">sortByStopSequence</a></li><li data-type='method'><a href="StopTime.html#.sortByStopTransferWeight">sortByStopTransferWeight</a></li></ul></li><li><a href="Trip.html">Trip</a><ul class='methods'><li data-type='method'><a href="Trip.html#.sortByDepartureTime">sortByDepartureTime</a></li><li data-type='method'><a href="Trip.html#getStopTime">getStopTime</a></li><li data-type='method'><a href="Trip.html#hasStopTime">hasStopTime</a></li></ul></li><li><a href="TripSearch.html">TripSearch</a><ul class='methods'><li data-type='method'><a href="TripSearch.html#search">search</a></li></ul></li><li><a href="TripSearchResult.html">TripSearchResult</a><ul class='methods'><li data-type='method'><a href="TripSearchResult.html#.sortByDeparture">sortByDeparture</a></li></ul></li><li><a href="TripSearchResultSegment.html">TripSearchResultSegment</a></li><li><a href="TripSearchResultTransfer.html">TripSearchResultTransfer</a></li></ul><h3>Modules</h3><ul><li><a href="module-_.html">/</a></li><li><a href="module-gtfs.html">gtfs</a></li><li><a href="module-gtfs_Agency.html">gtfs/Agency</a></li><li><a href="module-gtfs_Route.html">gtfs/Route</a></li><li><a href="module-gtfs_Service.html">gtfs/Service</a></li><li><a href="module-gtfs_ServiceException.html">gtfs/ServiceException</a></li><li><a href="module-gtfs_Stop.html">gtfs/Stop</a></li><li><a href="module-gtfs_StopTime.html">gtfs/StopTime</a></li><li><a href="module-gtfs_Trip.html">gtfs/Trip</a></li><li><a href="module-query.html">query</a><ul class='methods'><li data-type='method'><a href="module-query.html#.clearCache">clearCache</a></li></ul></li><li><a href="module-query_about.html">query/about</a><ul class='methods'><li data-type='method'><a href="module-query_about.html#~getAbout">getAbout</a></li></ul></li><li><a href="module-query_calendar.html">query/calendar</a><ul class='methods'><li data-type='method'><a href="module-query_calendar.html#~getService">getService</a></li><li data-type='method'><a href="module-query_calendar.html#~getServiceExceptions">getServiceExceptions</a></li><li data-type='method'><a href="module-query_calendar.html#~getServicesDefault">getServicesDefault</a></li><li data-type='method'><a href="module-query_calendar.html#~getServicesEffective">getServicesEffective</a></li></ul></li><li><a href="module-query_holiday.html">query/holiday</a><ul class='methods'><li data-type='method'><a href="module-query_holiday.html#~getHoliday">getHoliday</a></li><li data-type='method'><a href="module-query_holiday.html#~getHolidays">getHolidays</a></li><li data-type='method'><a href="module-query_holiday.html#~isHoliday">isHoliday</a></li></ul></li><li><a href="module-query_linegraph.html">query/linegraph</a><ul class='methods'><li data-type='method'><a href="module-query_linegraph.html#~buildGraph">buildGraph</a></li><li data-type='method'><a href="module-query_linegraph.html#~getNextStops">getNextStops</a></li><li data-type='method'><a href="module-query_linegraph.html#~getPaths">getPaths</a></li></ul></li><li><a href="module-query_links.html">query/links</a><ul class='methods'><li data-type='method'><a href="module-query_links.html#~getLinkCategories">getLinkCategories</a></li><li data-type='method'><a href="module-query_links.html#~getLinks">getLinks</a></li><li data-type='method'><a href="module-query_links.html#~getLinksByCategory">getLinksByCategory</a></li></ul></li><li><a href="module-query_routegraph.html">query/routegraph</a><ul class='methods'><li data-type='method'><a href="module-query_routegraph.html#~getNextStops">getNextStops</a></li></ul></li><li><a href="module-query_routes.html">query/routes</a><ul class='methods'><li data-type='method'><a href="module-query_routes.html#~getRoute">getRoute</a></li><li data-type='method'><a href="module-query_routes.html#~getRoutes">getRoutes</a></li></ul></li><li><a href="module-query_stops.html">query/stops</a><ul class='methods'><li data-type='method'><a href="module-query_stops.html#~getStop">getStop</a></li><li data-type='method'><a href="module-query_stops.html#~getStopByName">getStopByName</a></li><li data-type='method'><a href="module-query_stops.html#~getStopByStatusId">getStopByStatusId</a></li><li data-type='method'><a href="module-query_stops.html#~getStops">getStops</a></li><li data-type='method'><a href="module-query_stops.html#~getStopsByLocation">getStopsByLocation</a></li><li data-type='method'><a href="module-query_stops.html#~getStopsByRoute">getStopsByRoute</a></li></ul></li><li><a href="module-query_stoptimes.html">query/stoptimes</a><ul class='methods'><li data-type='method'><a href="module-query_stoptimes.html#~getStopTimeByTripStop">getStopTimeByTripStop</a></li><li data-type='method'><a href="module-query_stoptimes.html#~getStopTimesByTrip">getStopTimesByTrip</a></li></ul></li><li><a href="module-query_trips.html">query/trips</a><ul class='methods'><li data-type='method'><a href="module-query_trips.html#~getTrip">getTrip</a></li><li data-type='method'><a href="module-query_trips.html#~getTripByDeparture">getTripByDeparture</a></li><li data-type='method'><a href="module-query_trips.html#~getTripByShortName">getTripByShortName</a></li><li data-type='method'><a href="module-query_trips.html#~getTripsByDate">getTripsByDate</a></li></ul></li><li><a href="module-rt.html">rt</a></li><li><a href="module-rt_About.html">rt/About</a></li><li><a href="module-rt_Favorite.html">rt/Favorite</a></li><li><a href="module-rt_Holiday.html">rt/Holiday</a></li><li><a href="module-rt_Link.html">rt/Link</a></li><li><a href="module-search.html">search</a></li><li><a href="module-search_TripSearch.html">search/TripSearch</a></li><li><a href="module-search_TripSearchResult.html">search/TripSearchResult</a></li><li><a href="module-search_TripSearchResultSegment.html">search/TripSearchResultSegment</a></li><li><a href="module-search_TripSearchResultTransfer.html">search/TripSearchResultTransfer</a></li><li><a href="module-utils.html">utils</a></li><li><a href="module-utils_calc.html">utils/calc</a><ul class='methods'><li data-type='method'><a href="module-utils_calc.html#~distance">distance</a></li></ul></li><li><a href="module-utils_DateTime.html">utils/DateTime</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">query/LineGraphTable.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * ### Line Graph Query Functions
 * These functions query the `rt_line_graph` table in the Right Track Database.
 * @module query/linegraph
 */

const cache = require('memory-cache');
const Graph = require('../../lib/graph.js');
const StopsTable = require('./StopsTable.js');
const Stop = require('../gtfs/Stop.js');


// ==== QUERY FUNCTIONS ==== //


/**
 * Get a List of all stops from the Agency Line Graph along all paths from
 * the origin to the destination following the specified stop
 * @param {RightTrackDB} db The Right Track DB to Query
 * @param {String} originId Origin Stop ID
 * @param {String} destinationId Destination Stop ID
 * @param {String} stopId Current Stop ID
 * @param {function} callback Callback function
 * @param {Error} callback.err Database Query Error
 * @param {String[]} [callback.stops] List of following Stops, sorted by transfer weight
 */
function getNextStops(db, originId, destinationId, stopId, callback) {

  // Get the Paths from origin --> destination
  getPaths(db, originId, destinationId, function(err, paths) {

    // Database Query Error
    if ( err ) {
      return callback(err);
    }

    // List of Stops to return
    let rtn = [];

    // Parse the Paths
    for ( let i = 0; i &lt; paths.length; i++ ) {
      let path = paths[i];
      let stopFound = false;

      // Parse the Path's Stops
      for ( let j = 0; j &lt; path.length; j++ ) {
        let stop = path[j];

        // First: find the current stop
        if ( !stopFound &amp;&amp; stop.id === stopId ) {
          stopFound = true;
        }

        // Add following stops...
        else if ( stopFound ) {

          // ...if not already in the rtn list
          let added = false;
          for ( let k = 0; k &lt; rtn.length; k++ ) {
            if ( rtn[k].id === stop.id ) {
              added = true;
            }
          }
          if ( !added ) {
            rtn.push(stop);
          }

        }

      }

    }

    // Sort the Stops by transfer weight
    rtn.sort(_sort);

    // Create an array of the IDs
    let ids = [];
    for ( let i = 0; i &lt; rtn.length; i++ ) {
      ids.push(rtn[i].id);
    }

    // Return the IDs
    return callback(null, ids);

  });


  /**
   * Sort the Graph Stops by transfer weight (descending)
   * @private
   */
  function _sort(a,b) {
    if (a.weight &lt; b.weight) {
      return 1;
    }
    else if (a.weight > b.weight) {
      return -1;
    }
    else {
      return 0;
    }
  }

}


/**
 * Get all possible paths from the origin to the destination following the
 * Agency Line Graph
 * @param {RightTrackDB} db The Right Track DB to Query
 * @param {String} originId Origin Stop ID
 * @param {String} destinationId Destination Stop ID
 * @param {function} callback Callback Function
 * @param {Error} callback.err Database Query Error
 * @param {Object[][]} [callback.paths] Route Paths
 * @param {String} callback.paths[].id Stop ID
 * @param {int} callback.paths[].weight Stop Transfer Weight
 */
function getPaths(db, originId, destinationId, callback) {

  // Get Graph
  buildGraph(db, function(err, graph) {
    if ( err ) {
      return callback(err);
    }

    // Paths to return
    let rtn = [];

    // Search the Graph
    for ( let it = graph.paths(originId, destinationId), kv; !(kv = it.next()).done;) {
      let path = [];
      for ( let i = 0; i &lt; kv.value.length; i++ ) {
        let stop = graph.vertexValue(kv.value[i]);
        path.push({
          id: stop.id,
          weight: stop.transferWeight
        });
      }
      rtn.push(path);
    }

    // Return the paths
    return callback(null, rtn);

  });

}



/**
 * Build the entire Agency Line Graph
 * @param {RightTrackDB} db The Right Track DB to query
 * @param {function} callback Callback function
 * @param {Error} callback.err Database Query Error
 * @param {Graph} [callback.graph] Agency Graph
 * @see {@link https://www.npmjs.com/package/graph.js|graph.js package}
 */
function buildGraph(db, callback) {

  // Check cache for graph
  let cacheKey = db.id + "-graph";
  let cache = cache_graph.get(cacheKey);
  if ( cache !== null ) {
    return callback(null, cache);
  }

  // Build Graph
  let graph = new Graph();

  // Add the Vertices
  _addGraphVertices(db, graph, function(err, graph) {

    // Database Query Error
    if ( err ) {
      return callback(err);
    }

    // Add Graph Edges
    _addGraphEdges(db, graph, function(err, graph) {

      // Database Query Error
      if ( err ) {
        return callback(err);
      }

      // Return the finished graph
      cache_graph.put(cacheKey, graph);
      return callback(null, graph);

    });

  });

}


/**
 * Add all Stops as Vertices to the Graph
 * @param {RightTrackDB} db The Right Track DB to query
 * @param {Graph} graph The Graph to add vertices to
 * @param {function} callback Callback function(err, graph)
 * @private
 */
function _addGraphVertices(db, graph, callback) {

  // Get all Stops
  StopsTable.getStops(db, function(err, stops) {

    // Database Query Error
    if ( err ) {
      return callback(err);
    }

    // Add each Stop as a Vertex
    for ( let i = 0; i &lt; stops.length; i++ ) {
      graph.addNewVertex(stops[i].id, stops[i]);
    }

    // Return the Graph
    return callback(null, graph);

  });

}

/**
 * Add edges to each Vertex in the Graph
 * @param {RightTrackDB} db The Right Track DB to query
 * @param {Graph} graph The Graph to add edges to
 * @param {function} callback Callback function(err, graph)
 * @private
 */
function _addGraphEdges(db, graph, callback) {

  // Counters
  let done = 0;
  let count = graph.vertexCount();

  // Loop through each Vertex in the Graph
  for ( let [stopId, stop] of graph ) {

    // Get the Edges for the Vertex
    _getStopEdges(db, stopId, function(err, edges) {

      // Database Query Error
      if ( err ) {
        return callback(err);
      }

      // Add each edge to the Graph
      for ( let i = 0; i &lt; edges.length; i++ ) {
        graph.ensureEdge(stopId, edges[i]);
        graph.ensureEdge(edges[i], stopId);
      }

      // Finish the Vertex
      _finish();

    });

  }

  // Keep track of finished vertices
  function _finish() {
    done++;
    if ( done === count ) {
      return callback(null, graph);
    }
  }

}


/**
 * Get the Line Graph Edges (next Stop ID, direction, and weight)
 * for the specified Stop
 * @param {RightTrackDB} db The Right Track Database to query
 * @param {String} firstId The first Stop ID
 * @param {function} callback Callback Function(err, edges)
 * @private
 */
function _getStopEdges(db, firstId, callback) {

  // Check cache for edges
  let cacheKey = db.id + "-" + firstId;
  let cache = cache_edges.get(cacheKey);
  if ( cache !== null ) {
    return callback(null, cache);
  }

  // Build Select Statement
  let select = "SELECT stop2_id FROM rt_line_graph WHERE stop1_id='" + firstId + "';";

  // Query the database
  db.select(select, function(err, results) {

    // Database Query Error
    if ( err ) {
      return callback(err);
    }

    // List of edges to return
    let rtn = [];

    // Add each connected stop
    for ( let i = 0; i &lt; results.length; i++ ) {
      rtn.push(results[i].stop2_id);
    }

    // Return edges
    cache_edges.put(cacheKey, rtn);
    return callback(null, rtn);

  });

}




// ==== SETUP CACHES ==== //
let cache_firstStops = new cache.Cache();
let cache_edges = new cache.Cache();
let cache_graph = new cache.Cache();


/**
 * Clear the RouteGraphTable caches
 * @private
 */
function clearCache() {
  cache_firstStops.clear();
  cache_edges.clear();
  cache_graph.clear();
}


// Export Functions
module.exports = {
  buildGraph: buildGraph,
  getPaths: getPaths,
  getNextStops: getNextStops,
  clearCache: clearCache
};</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Sat Jan 11 2020 18:21:59 GMT-0500 (Eastern Standard Time) using the <a href="https://github.com/dwaring87/docdash">@dwaring87/docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
