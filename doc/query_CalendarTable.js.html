<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>query/CalendarTable.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="About.html">About</a></li><li><a href="Agency.html">Agency</a></li><li><a href="DateTime.html">DateTime</a><ul class='methods'><li data-type='method'><a href="DateTime.html#.create">create</a></li><li data-type='method'><a href="DateTime.html#.createFromDate">createFromDate</a></li><li data-type='method'><a href="DateTime.html#.createFromTime">createFromTime</a></li><li data-type='method'><a href="DateTime.html#getDateDOW">getDateDOW</a></li><li data-type='method'><a href="DateTime.html#getDateInt">getDateInt</a></li><li data-type='method'><a href="DateTime.html#getNextDateInt">getNextDateInt</a></li><li data-type='method'><a href="DateTime.html#getPreviousDateInt">getPreviousDateInt</a></li><li data-type='method'><a href="DateTime.html#getTimeGTFS">getTimeGTFS</a></li><li data-type='method'><a href="DateTime.html#getTimeSeconds">getTimeSeconds</a></li><li data-type='method'><a href="DateTime.html#isDateSet">isDateSet</a></li><li data-type='method'><a href="DateTime.html#toString">toString</a></li></ul></li><li><a href="Holiday.html">Holiday</a></li><li><a href="Link.html">Link</a></li><li><a href="Route.html">Route</a></li><li><a href="Service.html">Service</a></li><li><a href="ServiceException.html">ServiceException</a></li><li><a href="Stop.html">Stop</a><ul class='methods'><li data-type='method'><a href="Stop.html#.sortById">sortById</a></li><li data-type='method'><a href="Stop.html#.sortByName">sortByName</a></li><li data-type='method'><a href="Stop.html#.sortByTransferWeight">sortByTransferWeight</a></li></ul></li><li><a href="StopTime.html">StopTime</a><ul class='methods'><li data-type='method'><a href="StopTime.html#.sortByStopSequence">sortByStopSequence</a></li><li data-type='method'><a href="StopTime.html#.sortByStopTransferWeight">sortByStopTransferWeight</a></li></ul></li><li><a href="Trip.html">Trip</a><ul class='methods'><li data-type='method'><a href="Trip.html#getStopTime">getStopTime</a></li><li data-type='method'><a href="Trip.html#hasStopTime">hasStopTime</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#getAbout">getAbout</a></li><li><a href="global.html#getCategories">getCategories</a></li><li><a href="global.html#getHoliday">getHoliday</a></li><li><a href="global.html#getHolidays">getHolidays</a></li><li><a href="global.html#getLinks">getLinks</a></li><li><a href="global.html#getLinksByCategory">getLinksByCategory</a></li><li><a href="global.html#getRoute">getRoute</a></li><li><a href="global.html#getRoutes">getRoutes</a></li><li><a href="global.html#getService">getService</a></li><li><a href="global.html#getServiceExceptions">getServiceExceptions</a></li><li><a href="global.html#getServicesDefault">getServicesDefault</a></li><li><a href="global.html#getServicesEffective">getServicesEffective</a></li><li><a href="global.html#getStop">getStop</a></li><li><a href="global.html#getStopByName">getStopByName</a></li><li><a href="global.html#getStopByStatusId">getStopByStatusId</a></li><li><a href="global.html#getStops">getStops</a></li><li><a href="global.html#getStopsByRoute">getStopsByRoute</a></li><li><a href="global.html#getStopsWithStatus">getStopsWithStatus</a></li><li><a href="global.html#getStopTimeByTripStop">getStopTimeByTripStop</a></li><li><a href="global.html#getStopTimesByTrip">getStopTimesByTrip</a></li><li><a href="global.html#getTrip">getTrip</a></li><li><a href="global.html#getTripByDeparture">getTripByDeparture</a></li><li><a href="global.html#isHoliday">isHoliday</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">query/CalendarTable.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const Service = require("../gtfs/Service.js");
const ServiceException = require("../gtfs/ServiceException.js");
const DateTime = require("../utils/DateTime.js");


// ==== CALLBACK FUNCTIONS ==== //

/**
 * This callback if performed after a Service has been
 * selected from the database.
 * @callback getServiceCallback
 * @param {Service} service The selected Service
 */

/**
 * This callback if performed after Services have been
 * selected from the database.
 * @callback getServicesCallback
 * @param {Service[]} services The selected Services
 */

/**
 * This callback if performed after Service Excpetions have
 * been selected from the database.
 * @callback getServiceExceptionsCallback
 * @param {ServiceException[]} exceptions The selected Service Exceptions
 */



// ==== QUERY FUNCTIONS ==== //

/**
 * Get the Service(s) specified by Service ID(s) from the passed
 * database.  The Service will also include any included Service
 * Exceptions for the Service.
 *
 * **package:** core.query.calendar.getService()
 *
 * @param {RightTrackDB} db The Right Track Database to query
 * @param {String|String[]} id Service ID or list of Service IDs
 * @param {getServiceCallback|getServicesCallback} callback getService(s) callback function
 */
let getService = function(db, id, callback) {

    // When given a list of service ids to parse...
    if ( id instanceof Array ) {

        // list of services to return
        let rtn = [];

        // Parse each passed service id
        for ( let i = 0; i &lt; id.length; i++ ) {
            let serviceId = id[i];
            getService(db, serviceId, function(service) {
                rtn.push(service);
                if ( i === id.length-1 &amp;&amp; callback !== undefined ) {
                    callback(rtn);
                }
            });
        }

    }


    // When given a single service id to query...
    else {

        // Get the service exceptions for the specified service
        let select = "SELECT date, exception_type FROM gtfs_calendar_dates WHERE service_id='" + id + "' ORDER BY date ASC;";

        // Query the database
        db.select(select, function(results) {

            // List of service exceptions and start and end dates
            let exceptions = [];
            let start_date = 0;
            let end_date = 0;

            // Parse the service exceptions
            if ( results !== undefined ) {

                // Parse each returned row
                for ( let i = 0; i &lt; results.length; i++ ) {
                    let row = results[i];

                    let se = new ServiceException(
                        id,
                        row.date,
                        row.exception_type
                    );

                    // Add Service Exception to list
                    exceptions.push(se);

                    if ( i === 0 ) {
                        start_date = row.date;
                    }
                    else if ( i === results.length-1 ) {
                        end_date = row.date;
                    }
                }

            }

            // Get the default service information
            let select = "SELECT monday, tuesday, wednesday, thursday, friday, saturday, sunday, " +
                "start_date, end_date FROM gtfs_calendar WHERE service_id='" + id + "';";

            // Query the database
            db.get(select, function(result) {

                // Defaults, when no service in calendar table
                let mon = 0;
                let tue = 0;
                let wed = 0;
                let thu = 0;
                let fri = 0;
                let sat = 0;
                let sun = 0;

                // Get values selected from database
                if ( result !== undefined ) {
                    mon = result.monday;
                    tue = result.tuesday;
                    wed = result.wednesday;
                    thu = result.thursday;
                    fri = result.friday;
                    sat = result.saturday;
                    sun = result.sunday;
                    start_date = result.start_date;
                    end_date = result.end_date;
                }

                // Create Service
                let service = new Service(id, mon, tue, wed, thu, fri, sat, sun, start_date, end_date, exceptions);

                // return service in callback, if provided
                if ( callback !== undefined ) {
                    callback(service);
                }

            });

        });

    }

};

/**
 * Get the Services in effect on the specified date.  This includes
 * any exceptions found in the calendar_dates file.
 *
 * **package:** core.query.calendar.getServicesEffective()
 *
 * @param {RightTrackDB} db The Right Track Database to query
 * @param {int} date The date to query (yyyymmdd)
 * @param {getServicesCallback} callback getServices callback function
 */
let getServicesEffective = function(db, date, callback) {

    // Get the Default Services
    getServicesDefault(db, date, function(defaultServices) {

        // Get the Service Exceptions
        getServiceExceptions(db, date, function(serviceExceptions) {

            // List of Service IDs to Add to Default Services
            let serviceIdsToAdd = [];

            // Parse the exceptions
            for ( let i = 0; i &lt; serviceExceptions.length; i++ ) {
                let serviceException = serviceExceptions[i];

                // Exception Type: Added
                if ( serviceException.exceptionType === ServiceException.SERVICE_ADDED ) {

                    // Make sure service isn't already in list
                    let found = false;
                    for ( let j = 0; j &lt; defaultServices.length; j++ ) {
                        if ( defaultServices[j].id === serviceException.serviceId ) {
                            found = true;
                        }
                    }

                    // Flag Service ID to add
                    if ( !found ) {
                        serviceIdsToAdd.push(serviceException.serviceId);
                    }

                }

                // Exception Type: Removed
                else if ( serviceException.exceptionType === ServiceException.SERVICE_REMOVED ) {

                    // Find matching default service
                    let removeIndex = -1;
                    for ( let j = 0; j &lt; defaultServices.length; j++ ) {
                        if ( defaultServices[j].id === serviceException.serviceId ) {
                            removeIndex = j;
                        }
                    }

                    // Remove the matching service from default services list
                    if ( removeIndex !== -1 ) {
                        defaultServices.splice(removeIndex, 1);
                    }

                }

            }


            // Add services, if we need to
            if ( serviceIdsToAdd.length > 0 ) {
                getService(db, serviceIdsToAdd, function (services) {
                    for (let i = 0; i &lt; services.length; i++) {
                        let service = services[i];
                        defaultServices.push(service);
                    }
                    callback(defaultServices);
                });
            }

            else {
                callback(defaultServices);
            }

        });

    });

};


/**
 * Get the default Services in effect on the specified date.  These
 * services don't include any changes due to service exceptions.
 *
 * **package:** core.query.calendar.getServicesDefault()
 *
 * @param {RightTrackDB} db The Right Track Database to query
 * @param {int} date The date to query (yyyymmdd)
 * @param {getServicesCallback} callback getServices callback function
 */
let getServicesDefault = function(db, date, callback) {

    // Array of default services to return
    let rtn = [];

    // Get day of week
    let dt = DateTime.createFromDate(date);
    let dow = dt.getDateDOW();

    // Get default services
    let select = "SELECT service_id, monday, tuesday, wednesday, thursday, friday, saturday, sunday, " +
        "start_date, end_date FROM gtfs_calendar WHERE " + dow + "=" + Service.SERVICE_AVAILABLE + " " +
        "AND start_date&lt;=" + date + " AND end_date>=" + date + ";";

    // Query the database
    db.select(select, function(results) {

        // Parse the selected services
        if ( results !== undefined ) {

            // Parse each row in the results...
            for ( let i = 0; i &lt; results.length; i++ ) {
                let row = results[i];

                let service = new Service(
                    row.service_id,
                    row.monday,
                    row.tuesday,
                    row.wednesday,
                    row.thursday,
                    row.friday,
                    row.saturday,
                    row.sunday,
                    row.start_date,
                    row.end_date
                );

                rtn.push(service);
            }

        }

        // Return the default services with provided callback
        if ( callback !== undefined ) {
            callback(rtn);
        }

    });

};


/**
 * Get the Service Exceptions in effect on the specified date.  This includes
 * Services that are either added or removed on the specified date
 *
 * **package:** core.query.calendar.getServiceExceptions()
 *
 * @param {RightTrackDB} db The Right Track Database to query
 * @param {int} date The date to query (yyyymmdd)
 * @param {getServiceExceptionsCallback} callback getServiceExceptions callback function
 */
let getServiceExceptions = function(db, date, callback) {

    // Array of Service Exceptions to return
    let rtn = [];

    // Get service exceptions from calendar_dates
    let select = "SELECT service_id, date, exception_type " +
        "FROM gtfs_calendar_dates WHERE date=" + date + ";";

    // Query the database
    db.select(select, function(results) {

        // Parse the selected service exceptions...
        if ( results !== undefined ) {

            // Parse each row in the results
            for ( let i = 0; i &lt; results.length; i++ ) {
                let row = results[i];

                // Create Service Exception
                let se = new ServiceException(
                    row.service_id,
                    row.date,
                    row.exception_type
                );

                // Add Service Exception to return list
                rtn.push(se);
            }

        }

        // Return service exceptions with provided callback
        if ( callback !== undefined ) {
            callback(rtn);
        }

    });

};


// Export the functions
module.exports = {
    getService: getService,
    getServicesEffective: getServicesEffective,
    getServicesDefault: getServicesDefault,
    getServiceExceptions: getServiceExceptions
};</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Thu Sep 14 2017 15:36:21 GMT-0400 (EDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
